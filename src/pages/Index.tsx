import { useState, useEffect, useCallback } from "react";
import { WelcomeScreen } from "@/components/wizard/WelcomeScreen";
import { TutorialScreen } from "@/components/wizard/TutorialScreen";
import { ShirtSelectionScreen, type Shirt } from "@/components/wizard/ShirtSelectionScreen";
import { BackgroundSelectionScreen } from "@/components/wizard/BackgroundSelectionScreen";
import { UploadScreen } from "@/components/wizard/UploadScreen";
import { ResultScreen } from "@/components/wizard/ResultScreen";
import { BuyCreditsScreen } from "@/components/wizard/BuyCreditsScreen";
import { AccessDeniedScreen } from "@/components/wizard/AccessDeniedScreen";
import { StepIndicator } from "@/components/wizard/StepIndicator";
import { CreditsDisplay } from "@/components/CreditsDisplay";
import { useFanFrameAuth } from "@/hooks/useFanFrameAuth";
import { useFanFrameCredits } from "@/hooks/useFanFrameCredits";
import { FANFRAME_ENABLED, type Background } from "@/config/fanframe";
import { Loader2 } from "lucide-react";
import { toast } from "@/hooks/use-toast";

type WizardStep = "welcome" | "buy-credits" | "tutorial" | "shirt" | "background" | "upload" | "result";

const STEP_ORDER: WizardStep[] = ["welcome", "buy-credits", "tutorial", "shirt", "background", "upload", "result"];
const STEP_LABELS = ["InÃ­cio", "CrÃ©ditos", "Tutorial", "Manto", "CenÃ¡rio", "Foto", "Resultado"];

const Index = () => {
  const [currentStep, setCurrentStep] = useState<WizardStep>("welcome");
  const [selectedShirt, setSelectedShirt] = useState<Shirt | null>(null);
  const [selectedBackground, setSelectedBackground] = useState<Background | null>(null);
  const [uploadedImage, setUploadedImage] = useState<string | null>(null);

  const { 
    isAuthenticated, 
    isLoading: authLoading, 
    balance, 
    updateBalance,
    logout,
    getStoredToken 
  } = useFanFrameAuth();

  const { 
    fetchBalance, 
    isLoading: creditsLoading,
    clearGenerationId 
  } = useFanFrameCredits(logout);

  // Detectar retorno do pagamento PagBank
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const paymentStatus = params.get("payment");
    
    if (paymentStatus === "success") {
      // Limpar parÃ¢metros da URL
      window.history.replaceState({}, "", window.location.pathname);
      
      // Mostrar toast de sucesso
      toast({
        title: "Pagamento em processamento! ðŸŽ‰",
        description: "Seu saldo serÃ¡ atualizado em instantes",
      });
      
      // Atualizar saldo apÃ³s pequeno delay para dar tempo do webhook processar
      setTimeout(async () => {
        const newBalance = await fetchBalance();
        if (newBalance !== null) {
          updateBalance(newBalance);
        }
      }, 2000);
    }
  }, [fetchBalance, updateBalance]);

  // Fetch balance only once on initial authentication
  useEffect(() => {
    let isMounted = true;
    
    const loadInitialBalance = async () => {
      if (isAuthenticated && getStoredToken()) {
        const newBalance = await fetchBalance();
        if (isMounted && newBalance !== null) {
          updateBalance(newBalance);
        }
      }
    };
    
    loadInitialBalance();
    
    return () => {
      isMounted = false;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isAuthenticated]);

  const goToStep = useCallback((step: WizardStep) => {
    setCurrentStep(step);
  }, []);

  const handleShirtSelect = useCallback((shirt: Shirt) => {
    setSelectedShirt(shirt);
  }, []);

  const handleBackgroundSelect = useCallback((background: Background) => {
    setSelectedBackground(background);
  }, []);

  const handleImageUpload = useCallback((base64: string) => {
    setUploadedImage(base64);
  }, []);

  const handleClearImage = useCallback(() => {
    setUploadedImage(null);
  }, []);

  const handleTryAgain = useCallback(() => {
    clearGenerationId();
    setSelectedShirt(null);
    setSelectedBackground(null);
    goToStep("shirt");
  }, [clearGenerationId, goToStep]);

  const handleBalanceUpdate = useCallback((newBalance: number) => {
    updateBalance(newBalance);
  }, [updateBalance]);

  const handleNoCredits = useCallback(() => {
    goToStep("buy-credits");
  }, [goToStep]);

  const handleRefreshBalance = useCallback(async () => {
    const newBalance = await fetchBalance();
    if (newBalance !== null) {
      updateBalance(newBalance);
    }
  }, [fetchBalance, updateBalance]);

  // Loading state
  if (FANFRAME_ENABLED && authLoading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  // Not authenticated
  if (FANFRAME_ENABLED && !isAuthenticated) {
    return <AccessDeniedScreen />;
  }

  const currentStepNumber = STEP_ORDER.indexOf(currentStep) + 1;
  const showStepIndicator = currentStep !== "welcome" && currentStep !== "result";

  return (
    <div className="min-h-screen bg-background text-foreground overflow-x-hidden">
      {/* Credits Display */}
      {FANFRAME_ENABLED && (
        <div className="fixed top-2 right-2 sm:top-4 sm:right-4 z-50 safe-top safe-right">
          <CreditsDisplay 
            balance={balance} 
            isLoading={creditsLoading}
            onRefresh={handleRefreshBalance}
          />
        </div>
      )}

      {showStepIndicator && (
        <StepIndicator 
          currentStep={currentStepNumber} 
          totalSteps={STEP_ORDER.length} 
          labels={STEP_LABELS}
        />
      )}
      
      {currentStep === "welcome" && (
        <WelcomeScreen onStart={() => goToStep(FANFRAME_ENABLED && balance <= 0 ? "buy-credits" : "tutorial")} />
      )}

      {currentStep === "buy-credits" && (
        <BuyCreditsScreen 
          balance={balance}
          onRefreshBalance={handleRefreshBalance}
          isRefreshing={creditsLoading}
          onContinue={balance > 0 ? () => goToStep("tutorial") : undefined}
          fetchBalance={fetchBalance}
        />
      )}

      {currentStep === "tutorial" && (
        <TutorialScreen 
          onContinue={() => goToStep("shirt")} 
          onBack={() => goToStep(FANFRAME_ENABLED && balance <= 0 ? "buy-credits" : "welcome")}
        />
      )}

      {currentStep === "shirt" && (
        <ShirtSelectionScreen
          selectedShirt={selectedShirt}
          onSelectShirt={handleShirtSelect}
          onContinue={() => goToStep("background")}
          onBack={() => goToStep("tutorial")}
        />
      )}

      {currentStep === "background" && (
        <BackgroundSelectionScreen
          selectedBackground={selectedBackground}
          onSelectBackground={handleBackgroundSelect}
          onContinue={() => {
            if (balance <= 0) {
              goToStep("buy-credits");
              return;
            }
            goToStep("upload");
          }}
          onBack={() => goToStep("shirt")}
        />
      )}

      {currentStep === "upload" && (
        <UploadScreen
          uploadedImage={uploadedImage}
          onImageUpload={handleImageUpload}
          onClearImage={handleClearImage}
          onContinue={() => {
            if (balance <= 0) {
              goToStep("buy-credits");
              return;
            }
            goToStep("result");
          }}
          onBack={() => goToStep("background")}
        />
      )}

      {currentStep === "result" && selectedShirt && selectedBackground && uploadedImage && (
        <ResultScreen
          userImage={uploadedImage}
          selectedShirt={selectedShirt}
          selectedBackground={selectedBackground}
          balance={balance}
          onTryAgain={handleTryAgain}
          onBalanceUpdate={handleBalanceUpdate}
          onNoCredits={handleNoCredits}
        />
      )}
    </div>
  );
};

export default Index;
